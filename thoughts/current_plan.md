# Implementation Plan: AI-Generated NPC Conversations

## Overview
Implement AI-generated dialogue for NPC conversations. When players use the `talk` command, dialogue is dynamically generated by the AI service and persisted to the NPC's `greetings` list for consistency across sessions.

## Spec

When a player talks to an NPC:
1. If `ai_service` is available and NPC has fewer than 3 greetings, generate a new AI conversation response
2. Add the generated response to the NPC's `greetings` list (persists via existing serialization)
3. Use `get_greeting()` to display dialogue (works with both AI-generated and static greetings)
4. Graceful fallback: If AI unavailable, use existing `greetings` or `dialogue` field

Generated dialogue should:
- Match the world theme (fantasy, sci-fi, etc.)
- Be consistent with NPC's role (merchant, guard, quest giver)
- Be 1-3 sentences, conversational tone
- Include NPC's name context for personality

## Tests (tests/test_ai_conversations.py)

1. `test_generate_npc_dialogue_returns_string` - AIService.generate_npc_dialogue() returns a non-empty string
2. `test_generate_npc_dialogue_respects_theme` - Generated dialogue uses theme context
3. `test_npc_dialogue_added_to_greetings` - After AI generation, dialogue is added to NPC.greetings
4. `test_talk_command_uses_ai_when_available` - talk command triggers AI generation when greetings < 3
5. `test_talk_command_fallback_without_ai` - Without ai_service, falls back to existing behavior
6. `test_generated_dialogue_persisted` - Greetings persist through save/load cycle (uses existing serialization)
7. `test_dialogue_not_generated_when_greetings_full` - No AI call when NPC already has 3+ greetings

## Implementation Steps

### Step 1: Add `generate_npc_dialogue()` to AIService
**File:** `src/cli_rpg/ai_service.py`

Add method after `generate_area()` (around line 682):
```python
def generate_npc_dialogue(
    self,
    npc_name: str,
    npc_description: str,
    npc_role: str,  # "merchant", "guard", "quest_giver", "villager"
    theme: str,
    location_name: str = ""
) -> str:
    """Generate contextual dialogue for an NPC.

    Args:
        npc_name: Name of the NPC
        npc_description: NPC's description
        npc_role: Role type ("merchant", "quest_giver", "villager")
        theme: World theme (e.g., "fantasy", "sci-fi")
        location_name: Current location name for context

    Returns:
        Generated dialogue string (10-200 chars)

    Raises:
        AIGenerationError: If generation fails or response is invalid
        AIServiceError: If API call fails
    """
    prompt = self._build_npc_dialogue_prompt(
        npc_name=npc_name,
        npc_description=npc_description,
        npc_role=npc_role,
        theme=theme,
        location_name=location_name
    )

    response_text = self._call_llm(prompt)

    # Clean and validate response
    dialogue = response_text.strip().strip('"').strip("'")
    if len(dialogue) < 10:
        raise AIGenerationError("Generated dialogue too short")
    if len(dialogue) > 200:
        dialogue = dialogue[:197] + "..."

    return dialogue

def _build_npc_dialogue_prompt(
    self,
    npc_name: str,
    npc_description: str,
    npc_role: str,
    theme: str,
    location_name: str
) -> str:
    """Build prompt for NPC dialogue generation."""
    return self.config.npc_dialogue_prompt.format(
        npc_name=npc_name,
        npc_description=npc_description,
        npc_role=npc_role,
        theme=theme,
        location_name=location_name or "unknown location"
    )
```

### Step 2: Add dialogue prompt template to AIConfig
**File:** `src/cli_rpg/ai_config.py`

Add constant after `DEFAULT_LOCATION_PROMPT` (around line 37):
```python
DEFAULT_NPC_DIALOGUE_PROMPT = """Generate a single conversational greeting for an NPC in a {theme} RPG.

NPC: {npc_name}
Description: {npc_description}
Role: {npc_role}
Location: {location_name}

Write 1-2 sentences that:
- Match the {theme} setting
- Reflect the NPC's personality and role
- Sound natural and immersive

Respond with ONLY the dialogue text, no quotes or formatting."""
```

Add field to AIConfig dataclass (around line 66, after `location_generation_prompt`):
```python
npc_dialogue_prompt: str = field(default=DEFAULT_NPC_DIALOGUE_PROMPT)
```

Update `to_dict()` (around line 186):
```python
"npc_dialogue_prompt": self.npc_dialogue_prompt
```

Update `from_dict()` (around line 212):
```python
npc_dialogue_prompt=data.get("npc_dialogue_prompt", DEFAULT_NPC_DIALOGUE_PROMPT)
```

### Step 3: Update talk command to use AI generation
**File:** `src/cli_rpg/main.py`

In `handle_exploration_command()`, modify the `talk` command handler (around line 414-416).

After `game_state.current_npc = npc` and before the output line:
```python
# Generate AI dialogue if available and NPC needs more greetings
if game_state.ai_service and len(npc.greetings) < 3:
    try:
        role = "merchant" if npc.is_merchant else ("quest_giver" if npc.is_quest_giver else "villager")
        dialogue = game_state.ai_service.generate_npc_dialogue(
            npc_name=npc.name,
            npc_description=npc.description,
            npc_role=role,
            theme=game_state.theme,
            location_name=game_state.current_location
        )
        npc.greetings.append(dialogue)
    except Exception:
        pass  # Silent fallback to existing greetings
```

### Step 4: Verify persistence (no changes needed)
The existing `NPC.to_dict()` and `NPC.from_dict()` already serialize/deserialize the `greetings` field, and `GameState.to_dict()` persists locations with their NPCs. No code changes needed - just verify with tests.

## Verification
1. Run new tests: `pytest tests/test_ai_conversations.py -v`
2. Run related tests: `pytest tests/test_npc_greetings.py tests/test_shop_commands.py -v`
3. Run full suite: `pytest`
