# Terrain Overwrite Check - Implementation Plan

## Status: CRITICAL BLOCKER Investigation

## Summary
Audit ChunkManager for terrain mutation after initial generation and add defensive guards to ensure terrain immutability.

## Investigation Findings

### Current Architecture
1. **ChunkManager._chunks** stores generated terrain as `Dict[Tuple[int, int], Dict[Tuple[int, int], str]]`
2. **`get_or_generate_chunk()`** only generates if chunk not in cache (line 78-80)
3. **`set_tile_at()`** EXISTS and DOES modify terrain (lines 503-518) - **POTENTIAL ISSUE**
4. **`sync_with_locations()`** calls `set_tile_at()` to overwrite WFC terrain with location terrain (lines 520-545)

### Identified Mutation Points
1. **`set_tile_at()`** (wfc_chunks.py:503-518) - Intentionally overwrites terrain
2. **`sync_with_locations()`** (wfc_chunks.py:520-545) - Called at world creation to sync locations with WFC
3. **Location.terrain assignment** (game_state.py:851) - Sets terrain on Location object (not ChunkManager)

### Design Decision
The `set_tile_at()` method is **intentional** for syncing pre-existing locations with WFC terrain. The spec says "once terrain is generated by WFC for a coordinate, it is NEVER overwritten" - but `sync_with_locations()` is called ONCE at world creation to establish consistency, not during gameplay.

The real concern is whether terrain gets modified AFTER initial sync. We need:
1. A guard to detect unexpected overwrites during gameplay
2. A test to verify terrain immutability after initial setup

---

## Spec

**Terrain Immutability Contract:**
- After `sync_with_locations()` is called (once at world creation), no code path should modify terrain in `_chunks`
- `Location.terrain` must match `ChunkManager.get_tile_at()` for the same coordinates
- If terrain changes are detected after initial sync, raise `TerrainImmutabilityError`

---

## Tests (Write First)

### File: `tests/test_terrain_immutability.py`

```python
"""Tests for terrain immutability after initial generation."""

def test_set_tile_at_after_sync_logs_warning():
    """Calling set_tile_at after sync should log a warning (defensive guard)."""

def test_terrain_matches_chunk_on_location_creation():
    """When a location is created, its terrain must match ChunkManager."""

def test_terrain_unchanged_after_movement():
    """Moving to a location does not change its terrain in ChunkManager."""

def test_cached_chunk_terrain_immutable():
    """After chunk generation, the terrain values in _chunks don't change."""

def test_location_terrain_matches_chunk_terrain():
    """Location.terrain always matches ChunkManager.get_tile_at() for same coords."""
```

---

## Implementation Steps

### Step 1: Add defensive tracking to ChunkManager
**File:** `src/cli_rpg/wfc_chunks.py`

Add a `_synced` boolean flag that tracks whether `sync_with_locations()` has been called:
- Add `_synced: bool = False` to ChunkManager dataclass
- Set `_synced = True` at end of `sync_with_locations()`
- In `set_tile_at()`, if `_synced` is True, log a warning (not error, to avoid breaking existing code)

### Step 2: Add assertion helper method
**File:** `src/cli_rpg/wfc_chunks.py`

Add `assert_terrain_unchanged(coords, expected_terrain)` method that:
- Gets current terrain at coords
- Raises `AssertionError` if it doesn't match expected
- Used in tests and optionally at runtime with `__debug__`

### Step 3: Update Location creation to verify terrain consistency
**File:** `src/cli_rpg/game_state.py`

In the location creation path (around line 851), add an assertion that:
- If `chunk_manager` is present and `terrain` is set
- Verify `location.terrain == chunk_manager.get_tile_at(*coords)`

### Step 4: Add serialization for _synced flag
**File:** `src/cli_rpg/wfc_chunks.py`

Update `to_dict()` and `from_dict()` to include `_synced` flag so save/load preserves the immutability state.

---

## Acceptance Criteria Verification

- [x] **Confirm terrain is never overwritten (or find and fix the bug)**
  - Finding: `set_tile_at()` exists for sync, but not called after initial setup
  - Solution: Add `_synced` flag to detect post-sync modifications

- [ ] **Add assertion in ChunkManager to prevent terrain overwrites**
  - Add `_synced` flag and warning in `set_tile_at()`

- [ ] **Add test that verifies terrain immutability**
  - Add `test_terrain_immutability.py` with 5 tests

- [ ] **Location.terrain always matches chunk terrain at same coordinates**
  - Add assertion in location creation path
